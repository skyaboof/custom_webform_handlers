<?php

/**
 * @file
<<<<<<< HEAD
 * Custom Webform Handlers module.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_alter().
 */
function custom_webform_handlers_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  // Only target the specific webform
  if ($form_id === 'webform_submission_we_add_form' || 
      $form_id === 'webform_submission_we_edit_form' ||
      strpos($form_id, 'webform_submission_we_') === 0) {
    
    // Get API key from configuration
    $config = \Drupal::config('custom_webform_handlers.settings');
    $api_key = $config->get('google_maps_api_key');
    
    if (empty($api_key)) {
      \Drupal::logger('custom_webform_handlers')->warning('Google Maps API key is not configured.');
      return;
    }
    
    // Attach library
    $form['#attached']['library'][] = 'custom_webform_handlers/address_distance_calculator';
    
    // Pass settings directly to JavaScript with hardcoded field names
    $form['#attached']['drupalSettings']['custom_webform_handlers'] = [
      'google_maps_api_key' => $api_key,
      'handler_config' => [
        'origin_field' => 'origin_address',
        'destination_field' => 'destination_address',
        'distance_field' => 'calculated_distance',
      ],
      'auto_save' => TRUE,
      'saveUrl' => '/custom_webform_handlers/save',
      'csrfToken' => \Drupal::csrfToken()->get('custom_webform_handlers.save'),
    ];
    
    \Drupal::logger('custom_webform_handlers')->info('Attached library to form: @form_id', [
      '@form_id' => $form_id
    ]);
  }
}

/**
 * Implements hook_webform_submission_presave().
 */
function custom_webform_handlers_webform_submission_presave($submission) {
  // Only process for 'we' webform
  if ($submission->getWebform()->id() !== 'we') {
    return;
  }
  
  $config = \Drupal::config('custom_webform_handlers.settings');
  $api_key = $config->get('google_maps_api_key');
  
  if (!$api_key) {
    \Drupal::logger('custom_webform_handlers')->error('Google Maps API key is missing.');
    return;
  }
  
  $origin = $submission->getElementData('origin_address');
  $destination = $submission->getElementData('destination_address');
  
  if ($origin && $destination) {
    $url = 'https://maps.googleapis.com/maps/api/distancematrix/json?origins=' . urlencode($origin) . '&destinations=' . urlencode($destination) . '&key=' . $api_key;
    
    try {
      $response = \Drupal::httpClient()->get($url);
      $data = json_decode($response->getBody(), TRUE);
      
      if ($data['status'] === 'OK' && !empty($data['rows'][0]['elements'][0]['distance'])) {
        $distance = $data['rows'][0]['elements'][0]['distance']['value'] / 1000;
        $submission->setElementData('calculated_distance', round($distance, 2) . ' km');
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('custom_webform_handlers')->error('Distance calculation failed: @message', [
        '@message' => $e->getMessage()
      ]);
    }
=======
 * Main module file for Custom Webform Handlers.
 */

/**
 * Implements hook_help().
 */
function custom_webform_handlers_help($route_name, \Drupal\Core\Routing\RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.custom_webform_handlers':
      return '<p>' . t('Provides custom webform handlers for address validation and distance calculation.') . '</p>';
>>>>>>> 4f21d7e (Refactor Distance Calculator and Update Configuration)
  }
}