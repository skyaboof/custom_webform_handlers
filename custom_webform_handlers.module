<?php

  /**
   * @file
   * Custom Webform Handlers module.
   */

  /**
   * Implements hook_page_attachments().
   */
  function custom_webform_handlers_page_attachments(array &$attachments) {
    $route_name = \Drupal::routeMatch()->getRouteName();
    if (strpos($route_name, 'webform_submission_') === 0) {
      $config = \Drupal::config('custom_webform_handlers.settings');
      $api_key = trim((string) $config->get('google_maps_api_key'));

      if (!empty($api_key) && !isset($attachments['#attached']['html_head']['distance_calculator_google_maps'])) {
        $attachments['#attached']['html_head'][] = [
          [
            '#type' => 'html_tag',
            '#tag' => 'script',
            '#attributes' => [
              'src' => "https://maps.googleapis.com/maps/api/js?key={$api_key}&libraries=places",
              'async' => 'async',
              'defer' => 'defer',
            ],
          ],
          'distance_calculator_google_maps',
        ];
      }
    }
  }

  /**
   * Implements hook_form_alter().
   */
  function custom_webform_handlers_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
    if (strpos($form_id, 'webform_submission_') === 0) {
      $form['#attached']['library'][] = 'custom_webform_handlers/address_autocomplete';
      \Drupal::logger('custom_webform_handlers')->info('Attached address_autocomplete library to form: @form_id', ['@form_id' => $form_id]);
      
      $api_key = \Drupal::config('custom_webform_handlers.settings')->get('google_maps_api_key');
      if ($api_key) {
        $form['#attached']['drupalSettings']['custom_webform_handlers'] = $form['#attached']['drupalSettings']['custom_webform_handlers'] ?? [];
        $form['#attached']['drupalSettings']['custom_webform_handlers']['google_maps_api_key'] = $api_key;
        $save_url = \Drupal\Core\Url::fromRoute('custom_webform_handlers.save')->toString();
        $csrf_token = \Drupal::service('csrf_token')->get('custom_webform_handlers.save');
        $form['#attached']['drupalSettings']['custom_webform_handlers']['saveUrl'] = $save_url;
        $form['#attached']['drupalSettings']['custom_webform_handlers']['csrfToken'] = $csrf_token;
        \Drupal::logger('custom_webform_handlers')->info('Google Maps API key and settings attached to drupalSettings: @key', ['@key' => substr($api_key, 0, 10) . '...']);
      }
      else {
        \Drupal::logger('custom_webform_handlers')->error('Google Maps API key is missing in configuration.');
      }
    }
  }